# 功能规格说明：飞书 Skill 集成

**功能分支**: `001-feishu-websocket-integration`
**创建日期**: 2026-02-17
**状态**: 草稿
**输入**: 用户描述: "构建一个常驻监听功能,保持和feishu的长链接,实现在飞书中和bot发送信息,通过websocket和项目中mini_agent双向交流.这个功能要和已有功能保持解耦和独立性"

## 用户场景与测试 *(必填)*

### 用户故事 1 - 基础对话功能 (优先级: P1)

作为飞书用户，我希望能够向 Mini Agent Bot 发送文本消息并收到回复，这样我就可以直接在飞书中与 AI 助手交互，无需切换应用程序。

**为什么是这个优先级**: 这是核心 MVP 功能 - 没有基础的消息交换，整个集成就没有价值。这建立了基本的通信通道。

**独立测试方式**: 可以通过向飞书中的 bot 发送任意文本消息并验证收到文本回复来完成测试。作为可直接从飞书访问的对话式 AI 助手，能立即产生价值。

**验收场景**:

1. **假设** FeishuSkill 已注册到 Agent 且服务正在运行，**当**用户向 bot 发送"你好"，**那么** bot 在 30 秒内回复相关的文本消息。
2. **假设** FeishuSkill 已注册，**当**用户发送工作相关的问题，**那么** bot 处理问题并返回适当的回复。
3. **假设** bot 收到空消息，**当**消息内容为空白，**那么** bot 回复提示语，请用户提供输入。

---

### 用户故事 2 - 多用户会话隔离 (优先级: P2)

作为飞书用户，我希望我的对话历史与其他用户隔离，这样我的上下文和之前的交互不会被他人干扰。

**为什么是这个优先级**: 多用户生产环境必需。没有会话隔离，用户会看到彼此的上下文，导致 bot 在实际环境中无法使用。

**独立测试方式**: 可以通过让两个不同用户同时发送消息，并验证每个用户收到的回复仅基于自己的对话历史。

**验收场景**:

1. **假设**用户 A 已发送消息"我的名字是小明"，用户 B 已发送"我的名字是小红"，**当**用户 A 询问"我叫什么名字?"，**那么** bot 回复"小明"(而不是"小红")。
2. **假设**两个用户正在与 bot 交互，**当**两人在同一分钟内发送消息，**那么**每个用户收到适合自己对话上下文的回复。
3. **假设**用户有已存在的会话，**当**他们在 10 分钟后返回，**那么**他们的对话历史被保留，bot 记得之前的上下文。

---

### 用户故事 3 - 连接弹性 (优先级: P3)

作为飞书用户，我希望即使在网络问题发生时 bot 仍然可用，这样我可以可靠地使用助手而不会频繁断开连接。

**为什么是这个优先级**: 提高可靠性和用户体验。没有自动重连，bot 在任何网络波动后都需要手动重启。

**独立测试方式**: 可以通过模拟 WebSocket 断开连接，并验证服务自动重连并恢复处理消息。

**验收场景**:

1. **假设** bot 正在运行，**当** WebSocket 连接中断，**那么**服务在 5 秒内自动尝试重连。
2. **假设**重连尝试失败，**当**第一次重试失败，**那么**服务继续以指数退避方式重试。
3. **假设**中断后连接恢复，**当**新消息到达，**那么** bot 正常处理消息，无需手动重启。

---

### 用户故事 4 - 会话清理 (优先级: P4)

作为系统管理员，我希望不活跃的用户会话能被自动清理，这样系统资源不会被废弃的对话占用。

**为什么是这个优先级**: 运维效率。防止长时间运行的生产部署中出现内存泄漏和资源耗尽。

**独立测试方式**: 可以通过创建会话，等待超过超时时间，并验证会话已从内存中移除。

**验收场景**:

1. **假设**用户会话存在，**当**在配置的超时时间内没有活动，**那么**会话自动从内存中移除。
2. **假设**多个不活跃会话存在，**当**清理运行时，**那么**只移除过期会话，活跃会话保持不变。
3. **假设**会话被清理，**当**同一用户发送新消息，**那么**创建新会话(之前的上下文被重置)。

---

### 用户故事 5 - Skill 可插拔性 (优先级: P1)

作为 Mini Agent 用户，我希望 FeishuSkill 可以通过配置启用或禁用，这样可以在不影响核心功能的情况下添加或移除飞书集成。

**为什么是这个优先级**: 核心架构需求。必须确保 Feishu 集成是完全可选的模块，删除后不影响 Agent 原有功能。

**独立测试方式**: 可以通过禁用 Feishu 配置后运行 Agent，验证原有 CLI 交互功能完全正常。

**验收场景**:

1. **假设** FeishuSkill 已在配置中启用，**当**启动 Agent 时，**那么**自动建立飞书 WebSocket 连接并监听消息。
2. **假设** FeishuSkill 在配置中禁用，**当**启动 Agent 时，**那么**不建立任何飞书连接，Agent 正常运行原有 CLI 交互。
3. **假设**删除 FeishuSkill 模块，**当**运行 Agent 时，**那么** Agent 正常启动，无错误或异常。

---

### 用户故事 6 - Skill 注册机制 (优先级: P2)

作为开发者，我希望 FeishuSkill 有标准的注册机制，这样我可以方便地将新的长连接平台集成到 Agent 中。

**为什么是这个优先级**: 可扩展性需求。为未来接入其他平台（如 Slack、Discord）奠定基础。

**独立测试方式**: 可以通过注册另一个长连接 Skill 并验证其正常运行。

**验收场景**:

1. **假设** LongConnectionRegistry 已实现，**当** FeishuSkill 注册时，**那么**自动注册到 Agent 的事件系统中。
2. **假设** 多个长连接 Skill 同时注册，**当**事件到达时，**那么**正确路由到对应的 Skill 处理。

---

### 边界情况

- 飞书 API 暂时不可用时会发生什么？→ 服务应记录错误并以退避方式重试，尽可能排队消息。
- 消息超过最大长度时会发生什么？→ 响应应拆分为多条消息或截断并附带续接指示。
- Agent 处理时间过长时会发生什么？→ 服务应发送"处理中"状态，准备好后交付结果。
- 同一用户快速发送多条消息时会发生什么？→ 消息应排队并按用户顺序处理，以保持上下文完整性。

## 需求 *(必填)*

### 功能需求

- **FR-001**: 系统必须提供通用的长连接框架，支持多个平台同时连接。
- **FR-002**: FeishuSkill 必须作为可插拔模块实现，可通过配置启用/禁用。
- **FR-003**: FeishuSkill 必须与飞书事件服务建立并维持持久的 WebSocket 长连接。
- **FR-004**: 系统必须接收用户向 bot 发送消息时的飞书消息事件。
- **FR-005**: 系统必须通过飞书消息 API 向用户发送文本回复。
- **FR-006**: 系统必须为由 open_id 标识的每个唯一飞书用户维护独立的会话上下文。
- **FR-007**: 系统必须异步处理消息，以处理多个并发用户而不阻塞。
- **FR-008**: 系统必须在 WebSocket 连接丢失时自动重连。
- **FR-009**: 删除 FeishuSkill 模块后，Agent 必须能正常启动和运行原有功能。
- **FR-010**: 系统必须清理不活跃会话，在配置的超时时间后释放资源。
- **FR-011**: 系统必须记录连接状态、消息事件和错误以便故障排查。

### 关键实体

- **LongConnectionPlatform**: 通用长连接平台接口，定义连接、断开、接收消息等方法。
- **LongConnectionRegistry**: 长连接平台注册中心，管理所有已注册的平台。
- **FeishuSession**: 表示唯一的用户对话上下文，由飞书 open_id 标识。包含 Agent 实例、创建时间戳和最后活动时间戳。
- **FeishuEvent**: 表示来自飞书的传入事件，包含发送者信息、消息内容、事件类型和时间戳。

## 成功标准 *(必填)*

### 可衡量结果

- **SC-001**: 用户在正常情况下可在 30 秒内发送消息并收到回复。
- **SC-002**: 系统支持至少 50 个并发活跃用户会话而不降级。
- **SC-003**: 网络中断后 30 秒内自动重连成功。
- **SC-004**: 正常操作期间零消息丢失(所有发送的消息收到响应或错误通知)。
- **SC-005**: 会话隔离验证：多用户测试中 100% 的回复引用正确的用户上下文。
- **SC-006**: 服务可连续运行 24 小时无需人工干预。
- **SC-007**: FeishuSkill 禁用后，Agent 原有 CLI 功能完全正常。
- **SC-008**: 删除 FeishuSkill 模块后，Agent 无错误启动。

## 架构设计

### 整体架构

```
mini_agent/
├── agent.py                      # 现有 - 添加长连接事件处理器
├── cli.py                       # 现有 - 注册 FeishuSkill
├── skills/                      # 现有
│   └── feishu_skill/            # NEW: 飞书 Skill (可插拔)
│       ├── __init__.py
│       ├── skill.yaml           # Skill 元数据
│       ├── config.py            # Feishu 配置
│       ├── ws_client.py        # WebSocket 客户端
│       ├── event_handler.py     # 事件处理
│       ├── message.py           # 消息发送
│       └── session_manager.py  # 会话管理
└── long_connection/             # NEW: 通用长连接框架
    ├── __init__.py
    ├── base.py                  # LongConnectionPlatform 抽象类
    └── registry.py              # LongConnectionRegistry 注册中心
```

### 核心设计原则

1. **LongConnectionPlatform**: 抽象基类，定义 `connect()`, `disconnect()`, `on_message()`, `on_error()` 等接口
2. **LongConnectionRegistry**: 单例注册中心，管理所有已注册的平台实现
3. **FeishuSkill**: 实现 LongConnectionPlatform 接口，作为 Skill 注册
4. **事件驱动**: Agent 不使用 while true 轮询，而是通过事件回调机制接收消息

### 与 Agent 的集成

```
Agent 启动时:
1. 加载配置中的 enabled Skills
2. 对每个启用的 Skill 调用 registry.register(skill)
3. Skill 建立长连接
4. 消息通过回调传递给 Agent 处理

Skill 可禁用:
1. 在配置中设置 feishu.enabled: false
2. Agent 启动时不加载该 Skill
3. 原有的 CLI 交互完全正常
```

## 假设

1. 飞书 Bot 应用已在飞书开放平台创建并配置了适当的权限。
2. App ID、App Secret 和其他凭证可用于配置。
3. 飞书应用设置中已启用 `im.message.receive_v1` 事件订阅。
4. 用户已在飞书中将 bot 添加为联系人。
5. 托管环境支持出站 WebSocket 连接。
6. 假设标准网络可靠性(偶尔的断开由重连逻辑处理)。
7. 文本消息是主要消息类型；其他类型(卡片、图片)不在 MVP 范围内。

## 超出范围

- Webhook 回调模式(仅 WebSocket 长连接在范围内)
- 富消息类型(卡片、图片、文件) - MVP 仅支持文本
- 消息加密(encrypt_key) - 未来可选功能
- 每用户速率限制
- 水平扩展/多实例部署
- 消息持久化到数据库
- 管理监控仪表板
