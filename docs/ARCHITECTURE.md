# Mini Agent 项目架构

## 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户交互层                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         CLI (cli.py)                                 │   │
│  │  • 命令行参数解析                                                     │   │
│  │  • 交互式对话循环                                                     │   │
│  │  • 工具初始化与注册                                                   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              核心代理层                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                       Agent (agent.py)                               │   │
│  │  • 消息历史管理 (messages)                                            │   │
│  │  • Token 估算与自动摘要                                               │   │
│  │  • 主执行循环 (run)                                                   │   │
│  │  • 取消机制支持                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                    ┌─────────────────┼─────────────────┐
                    ▼                 ▼                 ▼
┌───────────────────────┐ ┌───────────────────┐ ┌───────────────────────┐
│      LLM 抽象层        │ │     工具层         │ │     配置层            │
│  ┌─────────────────┐  │ │  ┌─────────────┐  │ │  ┌─────────────────┐  │
│  │   LLMClient     │  │ │  │ Tool Base   │  │ │  │ Config         │  │
│  │ (llm_wrapper)   │  │ │  │ (base.py)   │  │ │  │ (config.py)    │  │
│  ├─────────────────┤  │ │  ├─────────────┤  │ │  ├─────────────────┤  │
│  │ • Anthropic     │  │ │  │ FileTools   │  │ │  │ • YAML 加载    │  │
│  │ • OpenAI        │  │ │  │ BashTool    │  │ │  │ • 优先级搜索   │  │
│  │ • 重试机制      │  │ │  │ NoteTool    │  │ │  │ • 路径解析     │  │
│  └─────────────────┘  │ │  │ MCP Tools   │  │ │  └─────────────────┘  │
└───────────────────────┘ │  │ SkillTool   │  │ └───────────────────────┘
                          │  └─────────────┘  │
                          └───────────────────┘
```

## Agent 执行循环流程图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            Agent 主循环                                      │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
                            ┌─────────────────┐
                            │   接收用户输入   │
                            └────────┬────────┘
                                     │
                                     ▼
                      ┌──────────────────────────┐
                      │  检查 Token 是否超限?     │
                      └────────────┬─────────────┘
                                   │
                    ┌──────────────┴──────────────┐
                    │ Yes                         │ No
                    ▼                             ▼
          ┌─────────────────┐           ┌─────────────────┐
          │  自动摘要历史   │           │                 │
          │  (保留关键信息) │           │                 │
          └────────┬────────┘           │                 │
                   │                    │                 │
                   └────────────────────┘                 │
                                   │                     │
                                   ▼                     │
                      ┌──────────────────────────┐       │
                      │  调用 LLM API            │       │
                      │  (带 System Prompt +     │       │
                      │   消息历史 + 工具 Schema) │       │
                      └────────────┬─────────────┘       │
                                   │                     │
                                   ▼                     │
                      ┌──────────────────────────┐       │
                      │  解析 LLM 响应           │       │
                      └────────────┬─────────────┘       │
                                   │                     │
                    ┌──────────────┴──────────────┐      │
                    │                             │      │
                    ▼                             ▼      │
          ┌─────────────────┐          ┌─────────────────┐
          │  文本响应       │          │  工具调用请求   │
          │  (返回给用户)   │          │  (Tool Calls)   │
          └─────────────────┘          └────────┬────────┘
                                                │
                                                ▼
                                   ┌──────────────────────────┐
                                   │  遍历执行工具            │
                                   │  • 解析工具名和参数      │
                                   │  • 异步执行 execute()   │
                                   │  • 收集 ToolResult      │
                                   └────────────┬─────────────┘
                                                │
                                                ▼
                                   ┌──────────────────────────┐
                                   │  追加工具结果到消息历史  │
                                   └────────────┬─────────────┘
                                                │
                                                ▼
                                   ┌──────────────────────────┐
                                   │  达到 max_steps?         │
                                   └────────────┬─────────────┘
                                                │
                         ┌──────────────────────┴──────────────────────┐
                         │ No                                          │ Yes
                         ▼                                             ▼
               ┌─────────────────┐                          ┌─────────────────┐
               │  继续循环       │                          │  停止执行       │
               │  (回到调用 LLM) │                          │  返回结果       │
               └─────────────────┘                          └─────────────────┘
```

## 工具系统架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              工具系统架构                                    │
└─────────────────────────────────────────────────────────────────────────────┘

                         ┌─────────────────────┐
                         │    Tool (基类)      │
                         │    (base.py)        │
                         ├─────────────────────┤
                         │ + name              │
                         │ + description       │
                         │ + parameters        │
                         │ + execute()         │
                         │ + to_schema()       │
                         └──────────┬──────────┘
                                    │
          ┌─────────────┬───────────┼───────────┬─────────────┐
          │             │           │           │             │
          ▼             ▼           ▼           ▼             ▼
┌──────────────┐ ┌──────────────┐ ┌────────┐ ┌──────────┐ ┌──────────────┐
│  FileTools   │ │  BashTool    │ │NoteTool│ │SkillTool │ │  MCP Tools   │
│ (file_tools) │ │ (bash_tool)  │ │(note)  │ │(skill)   │ │ (mcp_loader) │
├──────────────┤ ├──────────────┤ ├────────┤ ├──────────┤ ├──────────────┤
│ • ReadTool   │ │ • BashTool   │ │Session │ │get_skill │ │ 动态加载     │
│ • WriteTool  │ │ • BashOutput │ │NoteTool│ │          │ │ 外部 MCP     │
│ • EditTool   │ │ • BashKill   │ │Recall  │ │          │ │ 服务器工具   │
└──────────────┘ └──────────────┘ └────────┘ └──────────┘ └──────────────┘
```

## 配置加载优先级

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           配置文件搜索优先级                                 │
└─────────────────────────────────────────────────────────────────────────────┘

  优先级 1 (最高)                优先级 2                    优先级 3 (最低)
┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐
│ mini_agent/config/  │    │ ~/.mini-agent/      │    │ <package>/          │
│ config.yaml         │    │ config/config.yaml  │    │ config/config.yaml  │
│                     │    │                     │    │                     │
│ (开发模式)          │    │ (用户全局配置)      │    │ (安装模式)          │
└─────────────────────┘    └─────────────────────┘    └─────────────────────┘
         │                          │                          │
         └──────────────────────────┴──────────────────────────┘
                                    │
                                    ▼
                         ┌─────────────────────┐
                         │  Config.from_yaml() │
                         │  合并加载配置       │
                         └─────────────────────┘
```

## 数据流架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              数据流向                                        │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────┐      ┌─────────┐      ┌─────────┐      ┌─────────┐      ┌─────────┐
│  User   │─────▶│   CLI   │─────▶│  Agent  │─────▶│   LLM   │─────▶│ MiniMax │
│ Input   │      │         │      │         │      │ Client  │      │   API   │
└─────────┘      └─────────┘      └─────────┘      └─────────┘      └─────────┘
                                        │                               │
                                        │                               │
                                        ▼                               │
                                 ┌─────────────┐                        │
                                 │   Tools     │◀───────────────────────┘
                                 │ (执行工具)   │   (Tool Calls Response)
                                 └──────┬──────┘
                                        │
                                        ▼
                                 ┌─────────────┐
                                 │ ToolResult  │
                                 │  (结果)     │
                                 └──────┬──────┘
                                        │
                                        ▼
                                 ┌─────────────┐
                                 │  Message    │
                                 │  History    │
                                 └──────┬──────┘
                                        │
                                        ▼
                                 ┌─────────────┐
                                 │   Output    │
                                 │  (用户)     │
                                 └─────────────┘
```

## 核心数据模型

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Schema 数据模型 (schema.py)                        │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────┐     ┌─────────────────────┐     ┌─────────────────────┐
│      Message        │     │     ToolCall        │     │    LLMResponse     │
├─────────────────────┤     ├─────────────────────┤     ├─────────────────────┤
│ role: str           │     │ id: str             │     │ content: str        │
│ content: str|list   │     │ type: str           │     │ thinking: str|None  │
│ thinking: str|None  │     │ function:           │     │ tool_calls: list    │
│ tool_calls: list    │     │   FunctionCall      │     │ finish_reason: str  │
│ tool_call_id: str   │     │                     │     │ usage: TokenUsage   │
│ name: str|None      │     └─────────────────────┘     └─────────────────────┘
└─────────────────────┘
         │
         │ 包含
         ▼
┌─────────────────────┐     ┌─────────────────────┐
│    FunctionCall     │     │    TokenUsage       │
├─────────────────────┤     ├─────────────────────┤
│ name: str           │     │ prompt_tokens: int  │
│ arguments: dict     │     │ completion_tokens   │
└─────────────────────┘     │ total_tokens: int   │
                            └─────────────────────┘
```

## 关键文件职责总结

| 文件 | 职责 |
|------|------|
| `cli.py` | 入口点、交互循环、工具初始化 |
| `agent.py` | 核心执行循环、消息管理、自动摘要 |
| `llm/llm_wrapper.py` | LLM 统一接口、重试机制 |
| `llm/anthropic_client.py` | Anthropic API 客户端实现 |
| `llm/openai_client.py` | OpenAI 兼容 API 客户端实现 |
| `tools/base.py` | 工具基类定义 |
| `tools/file_tools.py` | 文件读写编辑工具 |
| `tools/bash_tool.py` | Shell 命令执行工具 |
| `tools/note_tool.py` | 会话笔记持久化工具 |
| `tools/mcp_loader.py` | MCP 工具动态加载 |
| `tools/skill_loader.py` | Claude Skills 加载器 |
| `tools/skill_tool.py` | Skills 工具封装 |
| `schema/schema.py` | Pydantic 数据模型 |
| `config.py` | 配置加载与解析 |
| `config/system_prompt.md` | 系统提示词模板 |
| `config/config.yaml` | 主配置文件 |
| `config/mcp.json` | MCP 服务器配置 |

## 目录结构

```
mini-agent/
├── mini_agent/                 # 核心源码
│   ├── __init__.py            # 模块导出
│   ├── agent.py               # Agent 核心类
│   ├── cli.py                 # 命令行入口
│   ├── config.py              # 配置管理
│   ├── logger.py              # 日志系统
│   ├── retry.py               # 重试机制
│   ├── llm/                   # LLM 客户端
│   │   ├── __init__.py
│   │   ├── base.py            # 基础客户端
│   │   ├── llm_wrapper.py     # 统一封装
│   │   ├── anthropic_client.py
│   │   └── openai_client.py
│   ├── tools/                 # 工具实现
│   │   ├── __init__.py
│   │   ├── base.py            # 工具基类
│   │   ├── file_tools.py      # 文件操作
│   │   ├── bash_tool.py       # Bash 执行
│   │   ├── note_tool.py       # 笔记工具
│   │   ├── mcp_loader.py      # MCP 加载
│   │   ├── skill_loader.py    # Skills 加载
│   │   └── skill_tool.py      # Skills 工具
│   ├── schema/                # 数据模型
│   │   ├── __init__.py
│   │   └── schema.py          # Pydantic 模型
│   ├── config/                # 配置文件
│   │   ├── config-example.yaml
│   │   ├── mcp-example.json
│   │   └── system_prompt.md
│   ├── skills/                # Claude Skills
│   │   └── ...                # 各类技能模块
│   ├── acp/                   # ACP 协议支持
│   │   ├── __init__.py
│   │   └── server.py          # ACP 服务器
│   └── utils/                 # 工具函数
│       ├── __init__.py
│       └── terminal_utils.py
├── tests/                     # 测试代码
├── docs/                      # 文档
├── workspace/                 # 工作目录
├── pyproject.toml             # 项目配置
└── uv.lock                    # 依赖锁定
```
